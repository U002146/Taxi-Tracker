<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸æ©Ÿå³æ™‚å®šä½ V1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* éš±è— Google Maps é è¨­æ§åˆ¶é …ï¼Œä¿æŒä»‹é¢æ¥µç°¡ */
        .gmnoprint, .gm-control-active { display: none !important; }
        /* å¸æ©Ÿæ¨¡å¼æ§åˆ¶å° */
        #driver-console { display: none; } 
        body { overflow: hidden; } /* é˜²æ­¢æ²å‹• */
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans">

    <div id="status-bar" class="bg-gray-800 text-white p-4 shadow-md z-50 flex items-center transition-colors duration-500">
        <img id="user-avatar" src="https://via.placeholder.com/40" class="w-12 h-12 rounded-full border-2 border-white mr-3 hidden">
        <div>
            <h2 id="welcome-text" class="text-lg font-bold">è¼‰å…¥ä¸­...</h2>
            <p id="status-text" class="text-sm opacity-90">æ­£åœ¨é€£ç·šè‡³è¡›æ˜Ÿ...</p>
        </div>
    </div>

    <div id="map" class="flex-grow w-full relative"></div>

    <div class="bg-white p-3 pb-8 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 grid grid-cols-3 gap-3">
        
        <a href="https://lin.ee/9Davl6e" target="_blank" class="flex flex-col items-center justify-center p-2 rounded-lg bg-green-50 active:bg-green-100 text-green-600">
            <i class="fa-solid fa-phone text-2xl mb-1"></i>
            <span class="text-xs font-bold">LINE é€šè©±</span>
        </a>

        <a href="https://liff.line.me/2008907691-lqyPtbIY" target="_blank" class="flex flex-col items-center justify-center p-2 rounded-lg bg-yellow-50 active:bg-yellow-100 text-yellow-600">
            <i class="fa-solid fa-taxi text-2xl mb-1"></i>
            <span class="text-xs font-bold">å³æ™‚å«è»Š</span>
        </a>

        <a href="https://liff.line.me/2008907691-v0O7W8d3" target="_blank" class="flex flex-col items-center justify-center p-2 rounded-lg bg-blue-50 active:bg-blue-100 text-blue-600">
            <i class="fa-solid fa-calendar-check text-2xl mb-1"></i>
            <span class="text-xs font-bold">é ç´„å«è»Š</span>
        </a>

    </div>

    <div id="driver-console" class="fixed inset-0 bg-black/90 z-[60] text-white flex flex-col items-center justify-center p-6">
        <h2 class="text-2xl font-bold mb-6 text-yellow-400">å¸æ©Ÿæ§åˆ¶å°</h2>
        <div class="text-center mb-8">
            <p>ç›®å‰ç‹€æ…‹ï¼š<span id="console-status" class="font-bold">æœªåˆ†äº«</span></p>
            <p class="text-xs text-gray-400 mt-2">GPS ç²¾åº¦: <span id="gps-accuracy">-</span> m</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 w-full max-w-xs mb-6">
            <button onclick="setDriverStatus('available')" class="p-4 bg-green-600 rounded-lg font-bold">æˆ‘æ˜¯ç©ºè»Š</button>
            <button onclick="setDriverStatus('busy')" class="p-4 bg-red-600 rounded-lg font-bold">è¼‰å®¢ä¸­</button>
        </div>
        
        <button id="toggle-share-btn" onclick="toggleSharing()" class="w-full max-w-xs p-4 bg-blue-600 rounded-lg font-bold mb-4">é–‹å§‹åˆ†äº«ä½ç½®</button>
        <button onclick="closeConsole()" class="text-gray-400 underline mt-4">é—œé–‰æ§åˆ¶å° (èƒŒæ™¯åŸ·è¡Œ)</button>
    </div>



    <script>
        // ========= CONFIG è¨­å®šå€ =========
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzsbd_NGCL835zkoICn71CtH7q5bH5E8Dpp5lYAFyAcoIZ7isNZ4bcqO9Qncd8UjunG/exec';
        const LIFF_ID = '2008907691-jxgYfAqx'; 
        const GOOGLE_MAPS_API_KEY = 'AIzaSyAlTcoOPEZeeMNwTGTap39VPsW85Ux8NHo';
        // ================================

        let map, carMarker;
        let driverData = { status: 'offline', heading: 0 };
        let watchId = null;
        let isSharing = false;
        let currentStatus = 'offline';
        let clickCount = 0; // éš±è—å…¥å£è¨ˆæ•¸

        // è¼‰å…¥ Google Maps script å‹•æ…‹æ³¨å…¥
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
            script.defer = true;
            document.body.appendChild(script);
        }

        // åˆå§‹åŒ–åœ°åœ– (é è¨­èŠ±è“®è»Šç«™)
        function initMap() {
            const hualienStation = { lat: 23.9933, lng: 121.6011 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: hualienStation,
                disableDefaultUI: true, // æ¥µç°¡æ¨¡å¼
                styles: [ { "featureType": "poi", "stylers": [{ "visibility": "off" }] } ] // éš±è—åœ°æ¨™è®“åœ°åœ–æ›´ä¹¾æ·¨
            });

            // å»ºç«‹è¨ˆç¨‹è»Šåœ–æ¨™ (SVG)
            const carSvg = {
                path: "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M23.044,41.388c0,2.571-2.085,4.656-4.656,4.656H5.643c-2.571,0-4.656-2.085-4.656-4.656v-9.522h12.753h9.3 V41.388z",
                fillColor: "#FFD700", // è¨ˆç¨‹è»Šé»ƒ
                fillOpacity: 1,
                scale: 0.8,
                strokeWeight: 1,
                strokeColor: "black",
                rotation: 0,
                anchor: new google.maps.Point(11.5, 23) // ä¸­å¿ƒé»ä¿®æ­£
            };

            carMarker = new google.maps.Marker({
                position: hualienStation,
                map: map,
                icon: carSvg,
                title: "å¸æ©Ÿä½ç½®"
            });

            // å•Ÿå‹•ä½ç½®è¼ªè©¢ (ä¹˜å®¢ç«¯)
            startPassengerPolling();
        }

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    updateTopBarUser(profile);
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF Init Error', err);
                document.getElementById('welcome-text').innerText = "æ­¡è¿å…‰è‡¨";
            }
        }

        // æ›´æ–°é ‚éƒ¨ä½¿ç”¨è€…è³‡è¨Šèˆ‡æ­¡è¿è©
        function updateTopBarUser(profile) {
            const avatar = document.getElementById('user-avatar');
            const welcome = document.getElementById('welcome-text');
            
            avatar.src = profile.pictureUrl;
            avatar.style.display = 'block';
            
            // å„²å­˜ç”¨æˆ¶åä»¥ä¾¿å‹•æ…‹æ›´æ–°
            window.userName = profile.displayName;
            updateStatusUI(currentStatus); // ç«‹å³è§¸ç™¼ä¸€æ¬¡ç‹€æ…‹æ–‡å­—æ›´æ–°
        }

        // ç‹€æ…‹ UI é‚è¼¯ (æ ¸å¿ƒéœ€æ±‚)
        function updateStatusUI(status) {
            const bar = document.getElementById('status-bar');
            const welcome = document.getElementById('welcome-text');
            const sub = document.getElementById('status-text');
            const name = window.userName || "ä¹˜å®¢";

            currentStatus = status;

            if (status === 'available') {
                // ç©ºè»Š: ç¶ è‰²
                bar.className = "bg-green-600 text-white p-4 shadow-md z-50 flex items-center transition-colors duration-500";
                welcome.innerText = `ä½ å¥½ï¼Œ${name}ï¼`;
                sub.innerText = "ğŸš• æˆ‘ç›®å‰æ˜¯ç©ºè»Šç‹€æ…‹ï¼Œæ­¡è¿æ­ä¹˜ï¼";
            } else if (status === 'busy') {
                // è¼‰å®¢ä¸­: ç´…è‰²
                bar.className = "bg-red-600 text-white p-4 shadow-md z-50 flex items-center transition-colors duration-500";
                welcome.innerText = `ä½ å¥½ï¼Œ${name}ï¼`;
                sub.innerText = "ğŸš« æˆ‘ç›®å‰æ˜¯è¼‰å®¢ä¸­ï¼Œè«‹ç¨å€™ã€‚";
            } else {
                // é›¢ç·š/ä¼‘æ¯: ç°è‰²
                bar.className = "bg-gray-800 text-white p-4 shadow-md z-50 flex items-center transition-colors duration-500";
                welcome.innerText = `ä½ å¥½ï¼Œ${name}ï¼`;
                sub.innerText = "ğŸ’¤ ç›®å‰ä¼‘æ¯ä¸­ã€‚";
            }
        }

        // ä¹˜å®¢ç«¯ï¼šæ¯ 5 ç§’å‘ GAS æŠ“å–æœ€æ–°ä½ç½®
        function startPassengerPolling() {
            setInterval(() => {
                fetch(GAS_URL)
                    .then(res => res.json())
                    .then(data => {
                        // æ›´æ–°åœ°åœ–æ¨™è¨˜
                        const newPos = { lat: parseFloat(data.lat), lng: parseFloat(data.lng) };
                        carMarker.setPosition(newPos);
                        
                        // æ›´æ–°è»Šé ­æ–¹å‘
                        const icon = carMarker.getIcon();
                        icon.rotation = parseInt(data.heading);
                        carMarker.setIcon(icon);

                        // å¦‚æœä½ç½®æ”¹è®Šå¾ˆå¤§ï¼Œå¹³æ»‘ç§»å‹•é¡é ­ (å¯é¸)
                        // map.panTo(newPos); 

                        // æ›´æ–°ç‹€æ…‹ UI
                        if (currentStatus !== data.status) {
                            updateStatusUI(data.status);
                        }
                    })
                    .catch(err => console.error("Polling Error", err));
            }, 5000); // 5ç§’æ›´æ–°ä¸€æ¬¡
        }

        // ========= å¸æ©Ÿç«¯é‚è¼¯ (æ›´æ–°ç‰ˆ) =========

        // ä¿®æ”¹è§¸ç™¼æ©Ÿåˆ¶ï¼šæ”¹ç‚ºé»æ“Šã€Œå·¦ä¸Šè§’å¤§é ­è²¼ã€
        // ç‚ºäº†è®“é»æ“Šæ›´é †æ‰‹ï¼Œæˆ‘å€‘ä¹ŸåŠ åœ¨ user-avatar ä¸Š
        document.getElementById('user-avatar').addEventListener('click', handleSecretTrigger);
        // å‚™ç”¨ï¼šå¦‚æœé ­åƒæ²’è¼‰å…¥ï¼Œé»æ“Šæ­¡è¿æ–‡å­—ä¹Ÿå¯ä»¥
        document.getElementById('welcome-text').addEventListener('click', handleSecretTrigger);

        function handleSecretTrigger() {
            clickCount++;
            console.log("Debug: Clicked " + clickCount); // æ–¹ä¾¿é™¤éŒ¯
            
            if (clickCount >= 5) {
                // ç‚ºäº†é¿å…èª¤è§¸ï¼Œé‡ç½®è¨ˆæ•¸å™¨å»¶é²ä¸€é»
                const pwd = prompt("è«‹è¼¸å…¥å¸æ©Ÿå¯†ç¢¼:");
                if (pwd === "400788") { 
                    document.getElementById('driver-console').style.display = 'flex';
                }
                clickCount = 0;
            }
            
            // å¦‚æœ 2 ç§’å…§æ²’ç¹¼çºŒé»ï¼Œè¨ˆæ•¸æ­¸é›¶ (é˜²æ­¢ä¹˜å®¢äº‚é»ç´¯ç©)
            if (window.clickTimer) clearTimeout(window.clickTimer);
            window.clickTimer = setTimeout(() => { clickCount = 0; }, 2000);
        }

        function closeConsole() {
            document.getElementById('driver-console').style.display = 'none';
        }

        function setDriverStatus(status) {
            currentStatus = status;
            document.getElementById('console-status').innerText = status === 'available' ? "ç©ºè»Š (ç¶ )" : "è¼‰å®¢ (ç´…)";
            // ç«‹å³ä¸Šå‚³ä¸€æ¬¡ç‹€æ…‹è®Šæ›´
            uploadLocation(lastLat, lastLng, lastHeading, lastSpeed);
        }

        let lastLat = 0, lastLng = 0, lastHeading = 0, lastSpeed = 0;

        function toggleSharing() {
            const btn = document.getElementById('toggle-share-btn');
            if (!isSharing) {
                // é–‹å§‹åˆ†äº«
                if (navigator.geolocation) {
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude, heading, speed } = position.coords;
                            lastLat = latitude;
                            lastLng = longitude;
                            lastHeading = heading || 0;
                            lastSpeed = speed || 0;
                            
                            document.getElementById('gps-accuracy').innerText = Math.round(position.coords.accuracy);
                            
                            // ä¸Šå‚³è‡³ GAS
                            uploadLocation(latitude, longitude, heading, speed);
                        },
                        (err) => alert("GPS éŒ¯èª¤: " + err.message),
                        { enableHighAccuracy: true, maximumAge: 0 }
                    );
                    isSharing = true;
                    btn.innerText = "åœæ­¢åˆ†äº«";
                    btn.classList.replace("bg-blue-600", "bg-gray-600");
                    document.getElementById('console-status').innerText = "æ­£åœ¨ä¸Šå‚³ GPS...";
                }
            } else {
                // åœæ­¢åˆ†äº«
                navigator.geolocation.clearWatch(watchId);
                isSharing = false;
                btn.innerText = "é–‹å§‹åˆ†äº«ä½ç½®";
                btn.classList.replace("bg-gray-600", "bg-blue-600");
                document.getElementById('console-status').innerText = "å·²åœæ­¢";
                // ä¸Šå‚³é›¢ç·šç‹€æ…‹
                setDriverStatus('offline'); 
            }
        }

        function uploadLocation(lat, lng, heading, speed) {
            // å»ºæ§‹ payload
            const payload = {
                lat: lat,
                lng: lng,
                status: currentStatus,
                heading: heading || 0,
                speed: speed || 0
            };

            // ä½¿ç”¨ fetch post (no-cors æ¨¡å¼ï¼Œåªé€ä¸è®€ï¼Œé€Ÿåº¦å¿«)
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                console.log("Uploaded");
            }).catch(e => console.error("Upload failed", e));
        }

        // å•Ÿå‹•ç¨‹å¼
        loadGoogleMaps();
        initLiff();

    </script>
</body>
</html>
